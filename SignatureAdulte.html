<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Formulaire Signature avec Code Unique</title>
    <style>
       h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .hidden-field {
            display: none;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background-color: #DCDCDC;
        }
		.form-container {
			display: flex;
			flex-direction: column;
			align-items: center; /* Centre le contenu, y compris l'image */
		}
		.form-container img {
			display: block;
			margin: auto;
		}
		.form-group {
			display: block; /* Garde tout aligné à gauche */
			text-align: left; /* Assure l'alignement des textes et du pad */
		}
		li {
		line-height: 1.4; /* Ajuste l'interligne à l'intérieur d'un même élément <li> */
		}
		#clear {
		margin-left: 75px; /* Ajoute une marge de 50px à gauche */
		display: block; /* Assure qu'il reste bien positionné */
		}
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .required {
            color: red;
            margin-left: 3px;
        }
        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        } 
		.help-text {
            color: #666666;
            font-size: 14px;
            margin-top: 4px;
        }
        .email-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        .email-container h2 {
            margin: 0;
        }
        .email-container .file-input-container {
            display: none; /* Cacher le sélecteur de fichier */
        }
        .instructions {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
		#signature-pad { border: 1px solid #cc0002; touch-action: none; background-color: #D3D3D3;}
        .form-group { margin-bottom: 1em; }
        .code-box { font-weight: bold; font-size: 1.2em; background: #e8e8e8; padding: 0.2em 0.5em; display: inline-block; border-radius: 4px; }
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="email"], input[type="tel"], input[type="number"],
        input[type="password"], input[type="date"], input[type="file"], select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            margin-bottom: 10px;
            background-color: #fafafa;
            transition: border 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border: 1.5px solid #4CAF50;
            background: #fff;
            outline: none;
            box-shadow: 0 1px 6px #4caf5044;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.7/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
		<!-- Logo -->
		<img src="
		" alt="Logo">
        <!-- =================== SIGNATURE ===================== -->		
		<h1>Signature de l'Adhésion et du Questionnaire Santé Adulte</h1>
		<div style="background-color: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 5px; border-left: 4px solid #4CAF50;">
		<p style="font-size: 1.2em; margin: 0 0 10px 0;"><strong>Comment signer ce document :</strong></p>
			<ol style="font-size: 0.9em; margin: 0; padding-left: 20px;">
				<li style="line-height: 1.4; margin-bottom: 10px;">Avec la souris ou un ThinkPad <i>(si vous en avez un)</i> ou avec le doigt si vous avez un écran tactile, <span style="color: red;">signez dans le PAD = Rectangle à bord rouge</span></li>
				<li style="line-height: 1.4; margin-bottom: 10px;">Cliquez sur "Valider" => votre fichier <span style="color: blue;">"NOM Prénom_Signature.pdf"</span> sera créé et enregistré dans votre dossier Téléchargement et le PDF s'affichera.</li>
				<li style="line-height: 1.4; margin-bottom: 10px;">Fermez le PDF et vous serez ramené au Questionnaire Santé en bas duquel le bouton <b>"Envoyer par courriel"</b> sera activé <i><span style="color: #4CAF50;">(sur fond vert)</span></i>.</li>
				<li style="line-height: 1.4; margin-bottom: 10px;">Une fenêtre courriel s'ouvrira il faudra y insérer les 3 fichiers que vous trouverez dans le dossier "Téléchargements" : <br><span style="color: blue;">"NOM Prénom_Adhésion_24-24.csv"</span> + <span style="color: blue;">"NOM Prénom_Questionnaire Santé Adulte_24-24.csv"</span> + <span style="color: blue;">"NOM Prénom_Signature_24-24.pdf"</span><br>les envoyer à l'adresse => <span style="color: blue;"><b>lentrainpourtous@epts.fr&nbsp;&nbsp;&nbsp;&nbsp;</b></span></li>
				<li style="line-height: 1.4; margin-bottom: 10px;">Pour que votre adhésion puisse être validée, vous devez faire parvenir votre paiement à l'association par chèque à l'ordre de l'<span style="color: blue;"><b><i>Entrain Pour Tous</i></b></span>.</li>
			</ol>
		<form id="signaturePDFAdulte">
			<div class="form-group">
                <label style="text-align: center; font-size: larger; font-style: italic;background-color: lightgray;padding: 5px 0;">Adhérent</label>
            </div> 
			<div class="form-group">
				<label for="nom">NOM</label>
                <input type="text" id="nom" name="nom" autocomplete="off" required readonly>
            </div>
            <div class="form-group">
                <label for="prenom">Prénom</label>
                <input type="text" id="prenom" name="prenom" autocomplete="off" required readonly>
            </div>
			<div class="form-group">
				<label for="mobile">Mobile</label>
				<input type="tel" id="mobile" name="mobile" required readonly maxlength="14" placeholder="0X XX XX XX XX" autocomplete="off">
			</div>
		<!-- Ajout du champ Date -->
			<div class="form-group">
				<label for="date">Date</label>
				<input type="text" id="date" name="date" readonly>
			</div>	
			<div class="form-group">
			  <label>Code unique :</label>
			  <span id="code-unique" class="code-box">------</span>
			</div>
			<div class="form-group">
				<label>Signer dans le rectangle</label><br>
				<canvas id="signature-pad" width="400" height="150"></canvas><br>
				<button type="button" id="clear">Effacer / refaire la signature</button>
			</div>
			<div class="button-container">
				<button class="button" type="submit" onclick="fermerFenetre()">Valider</button>
			</div>
		</form>
		<div style="text-align: center;">
		  <div id="after-upload-msg-signature" style="display:none; color: #2196F3; font-size: 1.2em; margin-top: 2em;">
			<b>
			  Un nouvel onglet vient de s’ouvrir.<br>
			  Cliquez sur le bouton « Sélectionner un fichier »<br>
			  Choisissez les deux fichiers CSV <u>et le PDF signature</u> téléchargés<br>
			  puis cliquez sur « Envoyer » pour finaliser l’inscription.
			</b>
		  </div>
		</div>
<script>
		// récupération des champs utiles
		document.addEventListener("DOMContentLoaded", function() {
			const urlParams = new URLSearchParams(window.location.search);

			// Récupérer les valeurs des paramètres d'URL
			const nom = urlParams.get('nom');
			const prenom = urlParams.get('prenom');
			const mobile = urlParams.get('mobile');

			// Utiliser les valeurs récupérées pour remplir les champs du formulaire
			if (nom) document.getElementById('nom').value = nom;
			if (prenom) document.getElementById('prenom').value = prenom;
			if (mobile) document.getElementById('mobile').value = mobile;
		});

		// Formatage des champs Nom et Prénom Adhérent
		document.getElementById('nom')?.addEventListener('input', function(e) {
		  let value = e.target.value.replace(/[^a-zA-ZÀ-ÿ\s\-]/g, '').toUpperCase();
		  e.target.value = value;
		});
		document.getElementById('prenom')?.addEventListener('input', function(e) {
		  let value = e.target.value.replace(/[^a-zA-ZÀ-ÿ \-]/g, '');
		  value = value.split(/[\s-]/).map(part => part ? part.charAt(0).toUpperCase() + part.slice(1).toLowerCase() : '').join('-');
		  e.target.value = value;
		});
		
		// Formatage du champ Mobile
        const mobileInput = document.getElementById('mobile');
        const mobileError = document.getElementById('mobileError');
        mobileInput.addEventListener('keydown', function(e) {
            const allowedKeys = ['Tab', 'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
            if (allowedKeys.includes(e.key)) return;
            if (!/[0-9]/.test(e.key)) e.preventDefault();
        });
        mobileInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '').substring(0, 10);
            if (value.length > 0) value = value.match(/.{1,2}/g)?.join(' ') || '';
            e.target.value = value;
            const numericValue = value.replace(/\s/g, '');
            const isValid = numericValue.length === 10 &&
                (numericValue.startsWith('06') || numericValue.startsWith('07'));
            mobileError.style.display = isValid ? 'none' : 'block';
            mobileInput.setCustomValidity(isValid ? '' : 'Numéro de mobile invalide');
            if (!isValid && numericValue.length === 10) {
                mobileError.textContent = 'Le numéro doit commencer par 06 ou 07';
            } else {
                mobileError.textContent = 'Format : 06 XX XX XX XX ou 07 XX XX XX XX';
            }
        });
		
		// Insertion de la Date
		document.addEventListener("DOMContentLoaded", function() {
			const dateField = document.getElementById("date");
			if (dateField) {
				const today = new Date();
				const formattedDate = today.toLocaleDateString("fr-FR", {
					day: "2-digit",
					month: "2-digit",
					year: "numeric"
				});
				dateField.value = formattedDate;
			}
		});

// ========== Génération du code unique =================
		// Assurez-vous que la bibliothèque Signature Pad est correctement chargée
		const canvas = document.getElementById('signature-pad');
		const signaturePad = new SignaturePad(canvas);

		// Fonction pour générer le code unique
		async function generateCode(nom, prenom, mobile, signatureData) {
			const input = nom.trim().toLowerCase() + ':' + prenom.trim().toLowerCase() + ':' + mobile.replace(/\s+/g, '') + ':' + signatureData;
			const encoder = new TextEncoder();
			const data = encoder.encode(input);
			const hashBuffer = await crypto.subtle.digest('SHA-256', data);
			const hashArray = Array.from(new Uint8Array(hashBuffer));
			const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
			return hashHex.substring(0, 6).toUpperCase();
		}

		// Fonction pour mettre à jour le code unique
		async function updateCode() {
			const nom = document.getElementById('nom').value;
			const prenom = document.getElementById('prenom').value;
			const tel = document.getElementById('mobile').value;
			const signatureData = signaturePad.toDataURL();

			if (nom && prenom && tel && !signaturePad.isEmpty()) {
				const code = await generateCode(nom, prenom, tel, signatureData);
				document.getElementById('code-unique').textContent = code;
			} else {
				document.getElementById('code-unique').textContent = '------';
			}
		}

		// Ajoutez des écouteurs d'événements pour les champs
		document.getElementById('nom').addEventListener('input', updateCode);
		document.getElementById('prenom').addEventListener('input', updateCode);
		document.getElementById('mobile').addEventListener('input', updateCode);

		// Écoutez les événements de la signature
		signaturePad.addEventListener('endStroke', updateCode);

		document.getElementById('clear').addEventListener('click', function(e) {
			e.preventDefault();
			signaturePad.clear();
			updateCode();
		});

		// Soumission du formulaire et génération du PDF
		document.getElementById('signaturePDFAdulte').addEventListener('submit', async function(e) {
		  e.preventDefault();
		  if (signaturePad.isEmpty()) {
			alert('Merci de signer avant de générer le PDF.');
			return;
		  }

		  const nom = document.getElementById('nom').value;
		  const prenom = document.getElementById('prenom').value;
		  const tel = document.getElementById('mobile').value;
		  const date = document.getElementById('date').value;
		  const signatureData = signaturePad.toDataURL();
		  const code = await generateCode(nom, prenom, tel, signatureData);
		  const { jsPDF } = window.jspdf;
		  const doc = new jsPDF();

	      //	Message
			  doc.setFontSize(16);
			  doc.setTextColor(0, 0, 255); // Couleur bleue
			  doc.text("Signature de l'Adhésion et du Questionnaire Santé Adulte", 105, 20, { align: "center" });
			  doc.setTextColor(0, 0, 0); // Couleur noire
			  doc.text(`Nom : ${nom}`, 10, 40);
			  doc.text(`Prénom : ${prenom}`, 10, 50);
			  doc.text(`Téléphone : ${tel}`, 10, 60);
			  doc.text(`Date : ${date}`, 10, 70);
			  doc.text(`Code unique : ${code}`, 10, 90);
			  doc.text('Signature :', 10, 100);
			  doc.addImage(signatureData, 'PNG', 10, 105, 80, 30);
				let y = 150;
				const lignes = [
				  "Votre signature est enregistrée,",
				  "vous DEVEZ fermer cette page pour accéder à l'écran suivant.",
				  " ",
				  "Vous serez redirigé vers le Questionnaire Santé",
				  "vous devrez y cliquer sur le bouton « Envoyer par courriel ».",
				  "Pensez à faire parvenir votre paiement à l'association",
				  " pour que votre adhésion puisse être validée."
				];

				lignes.forEach((texte, index) => {
				  if (index < 3) {
					doc.setTextColor(255, 0, 0); // Rouge pour les lignes 0 à 2
				  } else if (index < 5) {
					doc.setTextColor(0, 0, 0); // Noir pour les lignes 3 et 4
				  } else {
					doc.setTextColor(0, 0, 255); // Bleu pour les lignes 5 et 6
				  }
				  doc.text(texte, 105, y, { align: "center" });
				  y += 10;
				});
			  let nomFichier = `${nom} ${prenom}_Signature.pdf`;

		// Génération et téléchargement du PDF
		const blob = doc.output('blob');
		const a = document.createElement('a');
		a.href = URL.createObjectURL(blob);
		a.download = nomFichier;
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);
		setTimeout(() => {
		  URL.revokeObjectURL(a.href);
		}, 1000);

		// Ouvre la page pCloud et affiche le message d'aide
		setTimeout(function() {
		  window.open(
			'https://e.pcloud.com/#/puplink?code=I4j7ZsTGo6RI3mUmxSi74BVU2AY0HFBNV',
			'_blank'
		  );
		  const aide = document.getElementById('after-upload-msg-signature');
		  if (aide) aide.style.display = "block";
		}, 800);

		// Ferme la fenêtre "Signature" après un délai (3 secondes)
		setTimeout(function() {
		  if (window.opener && !window.opener.closed) {
			window.opener.focus();
		  }
		  window.close();
		}, 3000);

		});
 </script>
</body>
</html>
